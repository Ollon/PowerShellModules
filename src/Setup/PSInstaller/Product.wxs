<?xml version="1.0" encoding="UTF-8"?>
<Wix xmlns="http://wixtoolset.org/schemas/v4/wxs">

  <!--
   Unattended setup: The following variables can be set:
   -  INSTALLDIR: Full path to the installation directory
   -  SERVERS: Splunk servers to send data to
   -->

  <!--
      ====================================================================================
      Defines & Variables
   -->

  <!-- Full version number to display -->
  <?define VersionNumber="1.0.0.0" ?>

  <?define InfoURL="https://gitlab.com/bradmarshall/PowerShellModules" ?>

  <!-- 32-bit / 64-bit variables -->
  <?if $(var.Platform) = x64 ?>
  <?define Win64 = "yes" ?>
  <?define PlatformProgramFilesFolder = "ProgramFiles64Folder" ?>
  <?else ?>
  <?define Win64 = "no" ?>
  <?define PlatformProgramFilesFolder = "ProgramFilesFolder" ?>
  <?endif ?>

  <!--
   Upgrade code HAS to be the same for all updates.
   Once you've chosen it don't change it.
   -->
  <?define UpgradeCode="56ee7f5a-2e4d-49d6-bd4e-3b0d0e771537" ?>

  <Product Id="*" Name="PowerShellModules" Language="1033" Version="$(var.VersionNumber)" Manufacturer="Ollon, LLC" UpgradeCode="$(var.UpgradeCode)">

    <!-- Package IDs are valid for a single package version only - they are autogenerated by WiX -->
    <!-- Let's require Windows Installer 4.0 (included in Vista) -->
    <!-- And ALWAYS install per machine!!! -->
    <Package InstallerVersion="400" Compressed="yes" InstallScope="perMachine" Platform="x64" />

    <Media Id="1" Cabinet="PowerShellModules.cab" EmbedCab="yes" />

    <Icon Id="ProductIcon" SourceFile="PowerShell.ico" />
    <Property Id="ARPPRODUCTICON" Value="ProductIcon" />
    <Property Id="ARPHELPLINK" Value="$(var.InfoURL)" />
    <Property Id="ARPNOREPAIR" Value="yes" Secure="yes" />
    <Property Id="ARPNOMODIFY" Value="yes" Secure="yes" />

    <Directory Id="TARGETDIR" Name="SourceDir">
      <Directory Id="ProgramFiles64Folder">
        <Directory Id="WINDOWSPOWERSHELL64" Name="WindowsPowerShell">
          <Directory Id="MODULES" Name="Modules">
            <Directory Id="POWERSHELLINFRASTRUCTURE" Name="PowerShell.Infrastructure" />
            <Directory Id="POWERSHELLEDITORFEATURES" Name="PowerShell.EditorFeatures.UI" />
            <Directory Id="PSISEPROJECTEXPLORER" Name="PsISEProjectExplorer" />
          </Directory>
        </Directory>
      </Directory>
      <Directory Id="WindowsFolder">
        <Directory Id="SYSTEM32" Name="System32">
          <Directory Id="WINDOWSPOWERSHELL" Name="WindowsPowerShell">
            <Directory Id="V10" Name="v1.0" />
          </Directory>
        </Directory>
      </Directory>
    </Directory>

    <DirectoryRef Id="POWERSHELLINFRASTRUCTURE">
      <Component Id="COMPONENT_POWERSHELLINFRASTRUCTURE" Guid="3132AF08-8634-4237-A6AF-FD10AD32B374" Win64="yes" >
        <File Id="FILE_MicrosoftManagementInfrastructuredll"
              Source="$(var.Infrastructure.TargetDir)\PowerShell.Infrastructure\Microsoft.Management.Infrastructure.dll" />
        <File Id="FILE_PowerShellInfrastructuredll"
              Source="$(var.Infrastructure.TargetDir)\PowerShell.Infrastructure\PowerShell.Infrastructure.dll" />
        <File Id="FILE_PowerShellInfrastructurepsd1"
              Source="$(var.Infrastructure.TargetDir)\PowerShell.Infrastructure\PowerShell.Infrastructure.psd1" />
        <File Id="FILE_SystemManagementAutomationdll"
              Source="$(var.Infrastructure.TargetDir)\PowerShell.Infrastructure\System.Management.Automation.dll" />
      </Component>
    </DirectoryRef>

    <DirectoryRef Id="POWERSHELLEDITORFEATURES">
      <Component Id="COMPONENT_POWERSHELLEDITORFEATURES" Guid="D869433E-44EF-49F4-B4E2-8E76EA8421FC" Win64="yes">
        <File Id="FILE_ICSharpCodeAvalonEditDLL"
              Source="$(var.PowerShell.EditorFeatures.UI.TargetDir)ICSharpCode.AvalonEdit.dll" />
        <File Id="FILE_MicrosoftPowerShellEditorDLL"
              Source="$(var.PowerShell.EditorFeatures.UI.TargetDir)Microsoft.PowerShell.Editor.dll" />
        <File Id="FILE_MicrosoftPowerShellEditorServicesDLL"
              Source="$(var.PowerShell.EditorFeatures.UI.TargetDir)Microsoft.PowerShell.EditorServices.dll" />
        <File Id="FILE_MicrosoftPowerShellEditorServicesProtocolDLL"
              Source="$(var.PowerShell.EditorFeatures.UI.TargetDir)Microsoft.PowerShell.EditorServices.Protocol.dll" />
        <File Id="FILE_MicrosoftPowerShellGPowerShellDLL"
              Source="$(var.PowerShell.EditorFeatures.UI.TargetDir)Microsoft.PowerShell.GPowerShell.dll" />
        <File Id="FILE_MicrosoftPowerShellGraphicalHostDLL"
              Source="$(var.PowerShell.EditorFeatures.UI.TargetDir)Microsoft.PowerShell.GraphicalHost.dll" />
        <!--<File Id="FILE_EditorFeatures.UIDLL"
              Source="$(var.PowerShell.EditorFeatures.UI.TargetDir)PowerShell.EditorFeatures.dll" />
        <File Id="FILE_EditorFeatures.UIPDB"
              Source="$(var.PowerShell.EditorFeatures.UI.TargetDir)PowerShell.EditorFeatures.pdb" />-->
        <File Id="FILE_EditorFeatures.UIUIDLL"
              Source="$(var.PowerShell.EditorFeatures.UI.TargetDir)PowerShell.EditorFeatures.UI.dll" />
        <File Id="FILE_EditorFeatures.UIUIdllCONFIG"
              Source="$(var.PowerShell.EditorFeatures.UI.TargetDir)PowerShell.EditorFeatures.UI.dll.config" />
        <File Id="FILE_EditorFeatures.UIUIPDB"
              Source="$(var.PowerShell.EditorFeatures.UI.TargetDir)PowerShell.EditorFeatures.UI.pdb" />
        <File Id="FILE_Start-DebugPS1" Source="$(var.PowerShell.EditorFeatures.UI.TargetDir)Start-Debug.ps1" />
        <File Id="FILE_SystemManagementAutomationDLL"
              Source="$(var.PowerShell.EditorFeatures.UI.TargetDir)System.Management.Automation.dll" />

      </Component>
    </DirectoryRef>


    <DirectoryRef Id="V10">
      <Component Id="COMPONENT_POWERSHELLPROFILE" Guid="A0642BD5-968B-4E63-9E87-E39B0D7A3963" Win64="yes">
        <File Id="FILE_profilePS1" Source="profile.ps1" KeyPath="yes" />
      </Component>
    </DirectoryRef>

    <DirectoryRef Id="PSISEPROJECTEXPLORER">
      <Component Id="COMPONENT_PSISEPROJECTEXPLORER" Guid="AE8F4B65-4CB4-451A-9701-7A62EC967063" Win64="yes">
        <File Id="FILE_Lucene.NetDLL" Source="PsISEProjectExplorer\Lucene.Net.dll" />
        <File Id="FILE_NLogCONFIG" Source="PsISEProjectExplorer\NLog.config" />
        <File Id="FILE_NLogDLL" Source="PsISEProjectExplorer\NLog.dll" />
        <File Id="FILE_PsISEProjectExplorerDLL" Source="PsISEProjectExplorer\PsISEProjectExplorer.dll" />
        <File Id="FILE_PsISEProjectExplorerPSD1" Source="PsISEProjectExplorer\PsISEProjectExplorer.psd1" />
        <File Id="FILE_PsISEProjectExplorerPSM1" Source="PsISEProjectExplorer\PsISEProjectExplorer.psm1" />
        <File Id="FILE_PsISEProjectExplorerPS5DLL" Source="PsISEProjectExplorer\PsISEProjectExplorerPS5.dll"
              KeyPath="yes" />
        <File Id="FILE_SimpleInjectorDLL" Source="PsISEProjectExplorer\SimpleInjector.dll" />
      </Component>
    </DirectoryRef>

    <Feature Id="PowerShellModules" Title="PowerShell Modules" Level="1">
      <ComponentRef Id="COMPONENT_POWERSHELLINFRASTRUCTURE" />
      <ComponentRef Id="COMPONENT_POWERSHELLEDITORFEATURES" />
      <ComponentRef Id="COMPONENT_POWERSHELLPROFILE" />
      <ComponentRef Id="COMPONENT_PSISEPROJECTEXPLORER" />
    </Feature>
  </Product>
</Wix>
